<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive Avancée</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js" integrity="sha512-dfbpZfcQtUPvHTkrajAF953GgvmgJdQbbzFKB6MqlCdbDJAxBNseM1CN5mfqN0g1zCmE5wFkAu3J2H/K1EzhUw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* --- Style général et responsive --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Empêche le défilement de la page entière */
        }

        h1 {
            text-align: center;
            margin: 10px 0;
            font-size: 1.5rem;
            color: #333;
        }

        /* --- Conteneurs principaux --- */
        #map-container {
            flex: 1; /* Le conteneur de la carte prend l'espace restant */
            min-height: 50vh; /* Hauteur minimale pour la carte */
        }
        #map {
            width: 100%;
            height: 100%;
        }

        #table-container {
            height: 35vh; /* Hauteur fixe pour le tableau */
            overflow-y: auto; /* Permet de faire défiler le tableau verticalement */
            border-top: 2px solid #ccc;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        /* --- Style du tableau --- */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        thead th {
            background-color: #f2f2f2;
            position: sticky; /* En-tête de tableau fixe */
            top: 0;
            z-index: 10;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }

        /* --- Style pour la surbrillance --- */
        .highlight {
            background-color: #aedff7 !important; /* Couleur de surbrillance */
            font-weight: bold;
        }
        
        /* --- Style pour les images dans les popups et tooltips --- */
        .tooltip-photo {
            width: 80px;
            height: auto;
            display: block;
            margin-bottom: 5px;
        }

        .popup-photo {
            max-width: 100%;
            max-height: 200px;
            height: auto;
            border-radius: 4px;
        }
        
        /* Media query pour les écrans plus petits (mobiles) */
        @media (max-width: 768px) {
            body {
                height: auto; /* Permet le défilement sur mobile si nécessaire */
            }
            #map-container {
                height: 50vh;
            }
            #table-container {
                height: 45vh;
            }
            h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <h1>Carte interactive des points d'intérêt</h1>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <div id="table-container">
        <table id="data-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 1. CONFIGURATION ---
    const GEOJSON_URL = 'test json.geojson';
    const CSV_URL = 'test stmedard.csv';
    const DEFAULT_PHOTO_URL = '20250904_153527.jpg'; // Photo par défaut

    // Dictionnaire pour lier les fid aux couches Leaflet et aux lignes de tableau
    const layerMap = {}; // key: fid, value: leafletLayer
    const rowMap = {};   // key: fid, value: tableRowElement
    
    // --- 2. INITIALISATION DE LA CARTE ---
    const map = L.map('map').setView([44.87, -0.70], 13); // Centré approximativement
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // --- 3. CHARGEMENT ASYNCHRONE DES DONNÉES (GEOJSON & CSV) ---
    Promise.all([
        fetch(GEOJSON_URL).then(response => response.json()),
        fetch(CSV_URL).then(response => response.text())
    ])
    .then(([geojsonFeatures, csvText]) => {
        const csvData = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
        
        // --- 4. TRAITEMENT ET AFFICHAGE DES DONNÉES CSV DANS LE TABLEAU ---
        const tableHead = document.querySelector('#data-table thead');
        const tableBody = document.querySelector('#data-table tbody');
        
        // Création de l'en-tête du tableau
        const headers = Object.keys(csvData[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        // Remplissage du tableau
        csvData.forEach(rowData => {
            const tr = document.createElement('tr');
            tr.dataset.fid = rowData.fid; // Liaison via l'attribut data-fid

            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = rowData[header];
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
            rowMap[rowData.fid] = tr; // Stocker la référence de la ligne

            // Ajout de l'événement de clic sur la ligne du tableau
            tr.addEventListener('click', () => {
                const fid = tr.dataset.fid;
                const layer = layerMap[fid];
                if (layer) {
                    map.flyTo(layer.getLatLng(), 17); // Centre la carte et zoome sur le point
                    layer.openPopup();
                    highlightFeature(fid); // Appel de la fonction de surbrillance
                }
            });
        });

        // --- 5. TRAITEMENT ET AFFICHAGE DES DONNÉES GEOJSON SUR LA CARTE ---
        L.geoJSON(geojsonFeatures, {
            onEachFeature: (feature, layer) => {
                const props = feature.properties;
                const fid = props.fid;
                layerMap[fid] = layer; // Stocker la référence de la couche

                // Définir la photo (avec fallback)
                const photoUrl = props.Photo && props.Photo.trim() !== '' ? props.Photo : DEFAULT_PHOTO_URL;

                // Création du contenu pour le tooltip (survol)
                const tooltipContent = `
                    <b>${props.Notes || 'Sans description'}</b><br>
                    <img src="${photoUrl}" alt="Aperçu" class="tooltip-photo">
                `;
                layer.bindTooltip(tooltipContent);

                // Création du contenu pour le popup (clic)
                const popupContent = `
                    <img src="${photoUrl}" alt="${props.Notes}" class="popup-photo">
                `;
                layer.bindPopup(popupContent);

                // Ajout de l'événement de clic sur le marqueur
                layer.on('click', () => {
                    highlightFeature(fid);
                });
            }
        }).addTo(map);

    })
    .catch(error => {
        console.error("Erreur lors du chargement des données:", error);
        alert("Impossible de charger les données. Vérifiez la console pour plus de détails.");
    });

    // --- 6. FONCTION DE SYNCHRONISATION/SURBRILLANCE ---
    let lastHighlightedFid = null;

    function highlightFeature(fid) {
        // Réinitialiser la surbrillance précédente
        if (lastHighlightedFid) {
            rowMap[lastHighlightedFid]?.classList.remove('highlight');
        }

        // Appliquer la nouvelle surbrillance
        const targetRow = rowMap[fid];
        if (targetRow) {
            targetRow.classList.add('highlight');
            // Faire défiler le tableau pour que la ligne soit visible
            targetRow.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
        
        lastHighlightedFid = fid;
    }
});
</script>

</body>
</html>
